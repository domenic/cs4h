#!/usr/bin/env node

var argv = require('optimist').argv
  , path = require('path')
  , fs = require('fs')
  , matcha = require('..')
  , cwd = process.cwd();

var ui = require('../lib/matcha/interface');

if (argv.h || argv.help) {
  console.log();
  console.log('Matcha: help');
  console.log();
  console.log('Don\'t really have anything for you yet.');
  console.log('Check back soon.');
  console.log();
  process.exit(0);
}

if (argv.v || argv.version) {
  console.log(matcha.version);
  process.exit(0);
}

var files = argv._
  , re = /\.js$/;

if (!files.length) {
  files = fs.readdirSync('benchmark').filter(function(path){
    return path.match(re);
  }).map(function(_p){
    return path.join('benchmark', _p);
  });
}

files = files.map(function(_p){
  _p = require.resolve(path.join(cwd, _p));
  return _p;
});

var suite = new matcha.Suite();

load(files, function () {
  run(suite, process.exit);
});

function load (files, cb) {
  var after = files.length;
  ui(suite);
  files.forEach(function (file) {
    delete require.cache[file];
    suite.emit('pre-require', global);
    suite.emit('require', require(file));
    --after || cb();
  });
}

function run (suite, cb) {
  var runner = new matcha.Runner(suite);
  var reporter = new matcha.Reporter(runner);
  runner.run(cb);
}

